/*!
* SignalR JavaScript Library v0.5
* http://signalr.net/
*
* Copyright David Fowler and Damian Edwards 2012
* Licensed under the MIT.
* https://github.com/SignalR/SignalR/blob/master/LICENSE.md
*/

(function(a,b){var c,d,e,f,g;if(typeof a!="function")throw"SignalR: jQuery not found. Please ensure jQuery is referenced before the SignalR.js file.";if(!b.JSON)throw"SignalR: No JSON parser found. Please ensure json2.js is referenced before the SignalR.js file if you need to support clients without native JSON parsing support, e.g. IE<8.";e={onStart:"onStart",onStarting:"onStarting",onSending:"onSending",onReceived:"onReceived",onError:"onError",onReconnect:"onReconnect",onDisconnect:"onDisconnect"},f=function(a,c){if(c!==!1){var d;typeof b.console!="undefined"&&(d="["+(new Date).toTimeString()+"] SignalR: "+a,b.console.debug?b.console.debug(d):b.console.log&&b.console.log(d))}},c=function(a,b,d){return new c.fn.init(a,b,d)},c.fn=c.prototype={init:function(a,b,c){this.url=a,this.qs=b,typeof c=="boolean"&&(this.logging=c)},ajaxDataType:"json",logging:!1,reconnectDelay:2e3,start:function(d,f){var g=this,h={transport:"auto",xdomain:!1},j,k=a.Deferred();return g.transport?(k.resolve(g),k.promise
()):(a.type(d)==="function"?f=d:a.type(d)==="object"&&(a.extend(h,d),a.type(h.callback)==="function"&&(f=h.callback)),g.ajaxDataType=h.xdomain?"jsonp":"json",a(g).bind(e.onStart,function(){a.type(f)==="function"&&f.call(g),k.resolve(g)}),j=function(b,d){if(d=d||0,d>=b.length){g.transport||k.reject("SignalR: No transport could be initialized successfully. Try specifying a different transport or none at all for auto initialization.");return}var f=b[d],h=a.type(f)==="object"?f:c.transports[f];h.start(g,function(){g.transport=h,a(g).trigger(e.onStart)},function(){j(b,d+1)})},b.setTimeout(function(){var b=g.url+"/negotiate";a.ajax({url:b,global:!1,cache:!1,type:"GET",data:{},dataType:g.ajaxDataType,error:function(b){a(g).trigger(e.onError,[b]),k.reject("SignalR: Error during negotiation request: "+b)},success:function(b){if(g.appRelativeUrl=b.Url,g.id=b.ConnectionId,g.webSocketServerUrl=b.WebSocketServerUrl,!b.ProtocolVersion||b.ProtocolVersion!=="1.0"){a(g).trigger(e.onError,"SignalR: Incompatible protocol version."
),k.reject("SignalR: Incompatible protocol version.");return}a(g).trigger(e.onStarting);var d=[],f=[];a.each(c.transports,function(a){if(a==="webSockets"&&!b.TryWebSockets)return!0;f.push(a)}),a.isArray(h.transport)?a.each(h.transport,function(){var b=this;(a.type(b)==="object"||a.type(b)==="string"&&a.inArray(""+b,f)>=0)&&d.push(a.type(b)==="string"?""+b:b)}):a.type(h.transport)==="object"||a.inArray(h.transport,f)>=0?d.push(h.transport):d=f,j(d)}})},0),k.promise())},starting:function(b){var c=this,d=a(c);return d.bind(e.onStarting,function(){b.call(c),d.unbind(e.onStarting)}),c},send:function(a){var b=this;if(!b.transport)throw"SignalR: Connection must be started before data can be sent. Call .start() before .send()";return b.transport.send(b,a),b},sending:function(b){var c=this;return a(c).bind(e.onSending,function(){b.call(c)}),c},received:function(b){var c=this;return a(c).bind(e.onReceived,function(a,d){b.call(c,d)}),c},error:function(b){var c=this;return a(c).bind(e.onError,function(
a,d){b.call(c,d)}),c},disconnected:function(b){var c=this;return a(c).bind(e.onDisconnect,function(){b.call(c)}),c},reconnected:function(b){var c=this;return a(c).bind(e.onReconnect,function(){b.call(c)}),c},stop:function(){var b=this;return b.transport&&(b.transport.stop(b),b.transport=null),delete b.messageId,delete b.groups,a(b).trigger(e.onDisconnect),b},log:f},c.fn.init.prototype=c.fn,g={addQs:function(c,d){return d.qs?typeof d.qs=="object"?c+"&"+a.param(d.qs):typeof d.qs=="string"?c+"&"+d.qs:c+"&"+b.escape(d.qs.toString()):c},getUrl:function(a,c,d,e){var f=a.url,g="transport="+c+"&connectionId="+b.escape(a.id);return a.data&&(g+="&connectionData="+b.escape(a.data)),d?(e&&(f+="/reconnect"),a.messageId&&(g+="&messageId="+a.messageId),a.groups&&(g+="&groups="+b.escape(JSON.stringify(a.groups)))):f+="/connect",f+="?"+g,f=this.addQs(f,a)},ajaxSend:function(c,d){var f=c.url+"/send?transport="+c.transport.name+"&connectionId="+b.escape(c.id);f=this.addQs(f,c),a.ajax({url:f,global:!1,type
:"POST",dataType:c.ajaxDataType,data:{data:d},success:function(b){b&&a(c).trigger(e.onReceived,[b])},error:function(b,d){d!=="abort"&&(d!=="parsererror"||c.ajaxDataType!=="jsonp")&&a(c).trigger(e.onError,[b])}})},processMessages:function(b,c){var d=a(b);if(c){if(c.Disconnect){f("Disconnect command received from server",b.logging),b.stop(),d.trigger(e.onDisconnect);return}c.Messages&&a.each(c.Messages,function(){try{d.trigger(e.onReceived,[this])}catch(c){f("Error raising received "+c,b.logging),a(b).trigger(e.onError,[c])}}),c.MessageId&&(b.messageId=c.MessageId),c.TransportData&&(b.groups=c.TransportData.Groups)}},foreverFrame:{count:0,connections:{}}},c.transports={webSockets:{name:"webSockets",send:function(a,b){a.socket.send(b)},start:function(c,d,g){var h,j=!1,k;if(b.MozWebSocket&&(b.WebSocket=b.MozWebSocket),!b.WebSocket){g();return}c.socket||(c.webSocketServerUrl?h=c.webSocketServerUrl:(k=document.location.protocol==="https:"?"wss://":"ws://",h=k+document.location.host+c.appRelativeUrl
),a(c).trigger(e.onSending),h+=c.data?"?connectionData="+c.data+"&transport=webSockets&connectionId="+c.id:"?transport=webSockets&connectionId="+c.id,c.socket=new b.WebSocket(h),c.socket.onopen=function(){j=!0,d&&d()},c.socket.onclose=function(b){j?typeof b.wasClean!="undefined"&&b.wasClean===!1&&a(c).trigger(e.onError):g&&g(),c.socket=null},c.socket.onmessage=function(d){var g=b.JSON.parse(d.data),h;g&&(h=a(c),g.Messages?a.each(g.Messages,function(){try{h.trigger(e.onReceived,[this])}catch(a){f("Error raising received "+a,c.logging)}}):h.trigger(e.onReceived,[g]))})},stop:function(a){a.socket!==null&&(a.socket.close(),a.socket=null)}},serverSentEvents:{name:"serverSentEvents",timeOut:3e3,start:function(c,d,h){var j=this,k=!1,l=a(c),m=!d,o,p;if(c.eventSource&&c.stop(),!b.EventSource){h&&h();return}l.trigger(e.onSending),o=g.getUrl(c,this.name,m);try{c.eventSource=new b.EventSource(o)}catch(q){f("EventSource failed trying to connect with error "+q.Message,c.logging),h?h():(l.trigger(e.onError
,[q]),m&&(f("EventSource reconnecting",c.logging),j.reconnect(c)));return}p=b.setTimeout(function(){k===!1&&(f("EventSource timed out trying to connect",c.logging),h&&h(),m?(f("EventSource reconnecting",c.logging),j.reconnect(c)):j.stop(c))},j.timeOut),c.eventSource.addEventListener("open",function(){f("EventSource connected",c.logging),p&&b.clearTimeout(p),k===!1&&(k=!0,d&&d(),m&&l.trigger(e.onReconnect))},!1),c.eventSource.addEventListener("message",function(a){a.data!=="initialized"&&g.processMessages(c,b.JSON.parse(a.data))},!1),c.eventSource.addEventListener("error",function(a){if(!k){h&&h();return}f("EventSource readyState: "+c.eventSource.readyState,c.logging),a.eventPhase===b.EventSource.CLOSED?c.eventSource.readyState===b.EventSource.CONNECTING?(f("EventSource reconnecting due to the server connection ending",c.logging),j.reconnect(c)):(f("EventSource closed",c.logging),j.stop(c)):(f("EventSource error",c.logging),l.trigger(e.onError))},!1)},reconnect:function(a){var c=this;b.setTimeout
(function(){c.stop(a),c.start(a)},a.reconnectDelay)},send:function(a,b){g.ajaxSend(a,b)},stop:function(a){a&&a.eventSource&&(a.eventSource.close(),a.eventSource=null,delete a.eventSource)}},foreverFrame:{name:"foreverFrame",timeOut:3e3,start:function(c,d,h){var j=this,k=g.foreverFrame.count+=1,l,m,o=a("<iframe data-signalr-connection-id='"+c.id+"' style='position:absolute;top:0;left:0;width:0;height:0;visibility:hidden;'></iframe>");if(b.EventSource){h&&h();return}a(c).trigger(e.onSending),l=g.getUrl(c,this.name),l+="&frameId="+k,o.prop("src",l),g.foreverFrame.connections[k]=c,o.bind("readystatechange",function(){a.inArray(this.readyState,["loaded","complete"])>=0&&(f("Forever frame iframe readyState changed to "+this.readyState+", reconnecting",c.logging),j.reconnect(c))}),c.frame=o[0],c.frameId=k,d&&(c.onSuccess=d),a("body").append(o),m=b.setTimeout(function(){c.onSuccess&&(j.stop(c),h&&h())},j.timeOut)},reconnect:function(a){var c=this;b.setTimeout(function(){var b=a.frame,d=g.getUrl
(a,c.name,!0)+"&frameId="+a.frameId;b.src=d},a.reconnectDelay)},send:function(a,b){g.ajaxSend(a,b)},receive:g.processMessages,stop:function(b){b.frame&&(b.frame.stop?b.frame.stop():b.frame.document&&b.frame.document.execCommand&&b.frame.document.execCommand("Stop"),a(b.frame).remove(),delete g.foreverFrame.connections[b.frameId],b.frame=null,b.frameId=null,delete b.frame,delete b.frameId)},getConnection:function(a){return g.foreverFrame.connections[a]},started:function(b){b.onSuccess?(b.onSuccess(),b.onSuccess=null,delete b.onSuccess):a(b).trigger(e.onReconnect)}},longPolling:{name:"longPolling",reconnectDelay:3e3,start:function(c,d){var f=this;c.pollXhr&&c.stop(),c.messageId=null,b.setTimeout(function(){(function h(d,j){a(d).trigger(e.onSending);var k=d.messageId,l=k===null,m=g.getUrl(d,f.name,!l,j),p=null,q=!1;d.pollXhr=a.ajax({url:m,global:!1,type:"GET",dataType:c.ajaxDataType,success:function(c){var f=0,k=!1;j===!0&&q===!1&&(a(d).trigger(e.onReconnect),q=!0),g.processMessages(d,c),c&&
c.TransportData&&a.type(c.TransportData.LongPollDelay)==="number"&&(f=c.TransportData.LongPollDelay),c&&c.TimedOut&&(k=c.TimedOut),f>0?b.setTimeout(function(){h(d,k)},f):h(d,k)},error:function(f,g){g!=="abort"&&(p&&clearTimeout(p),a(d).trigger(e.onError,[f]),b.setTimeout(function(){h(d,!0)},c.reconnectDelay))}}),j===!0&&(p=b.setTimeout(function(){q===!1&&(a(d).trigger(e.onReconnect),q=!0)},f.reconnectDelay))})(c),b.setTimeout(d,150)},250)},send:function(a,b){g.ajaxSend(a,b)},stop:function(a){a.pollXhr&&(a.pollXhr.abort(),a.pollXhr=null,delete a.pollXhr)}}},c.noConflict=function(){return a.connection===c&&(a.connection=d),c},a.connection&&(d=a.connection),a.connection=a.signalR=c})(window.jQuery,window)