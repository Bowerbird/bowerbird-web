/*!
    * SignalR JavaScript Library v0.5
    * http://signalr.net/
    *
    * Copyright David Fowler and Damian Edwards 2012
    * Licensed under the MIT.
    * https://github.com/SignalR/SignalR/blob/master/LICENSE.md
    */

define(["jquery","json2"],function(a){(function(a,b){if(typeof a!="function")throw"SignalR: jQuery not found. Please ensure jQuery is referenced before the SignalR.js file.";if(!b.JSON)throw"SignalR: No JSON parser found. Please ensure json2.js is referenced before the SignalR.js file if you need to support clients without native JSON parsing support, e.g. IE<8.";var c,d,e={onStart:"onStart",onStarting:"onStarting",onSending:"onSending",onReceived:"onReceived",onError:"onError",onReconnect:"onReconnect",onDisconnect:"onDisconnect"},f=function(a,c){if(c===!1)return;var d;if(typeof b.console=="undefined")return;d="["+(new Date).toTimeString()+"] SignalR: "+a,b.console.debug?b.console.debug(d):b.console.log&&b.console.log(d)};c=function(a,b,d){return new c.fn.init(a,b,d)},c.fn=c.prototype={init:function(a,b,c){this.url=a,this.qs=b,typeof c=="boolean"&&(this.logging=c)},ajaxDataType:"json",logging:!1,reconnectDelay:2e3,start:function(d,f){var g=this,h={transport:"auto",xdomain:!1},i,j=a.Deferred
();return g.transport?(j.resolve(g),j.promise()):(a.type(d)==="function"?f=d:a.type(d)==="object"&&(a.extend(h,d),a.type(h.callback)==="function"&&(f=h.callback)),g.ajaxDataType=h.xdomain?"jsonp":"json",a(g).bind(e.onStart,function(b,c){a.type(f)==="function"&&f.call(g),j.resolve(g)}),i=function(b,d){d=d||0;if(d>=b.length){g.transport||j.reject("SignalR: No transport could be initialized successfully. Try specifying a different transport or none at all for auto initialization.");return}var f=b[d],h=a.type(f)==="object"?f:c.transports[f];h.start(g,function(){g.transport=h,a(g).trigger(e.onStart)},function(){i(b,d+1)})},b.setTimeout(function(){var b=g.url+"/negotiate";a.ajax({url:b,global:!1,cache:!1,type:"GET",data:{},dataType:g.ajaxDataType,error:function(b){a(g).trigger(e.onError,[b]),j.reject("SignalR: Error during negotiation request: "+b)},success:function(b){g.appRelativeUrl=b.Url,g.id=b.ConnectionId,g.webSocketServerUrl=b.WebSocketServerUrl;if(!b.ProtocolVersion||b.ProtocolVersion!=="1.0"
){a(g).trigger(e.onError,"SignalR: Incompatible protocol version."),j.reject("SignalR: Incompatible protocol version.");return}a(g).trigger(e.onStarting);var d=[],f=[];a.each(c.transports,function(a){if(a==="webSockets"&&!b.TryWebSockets)return!0;f.push(a)}),a.isArray(h.transport)?a.each(h.transport,function(){var b=this;(a.type(b)==="object"||a.type(b)==="string"&&a.inArray(""+b,f)>=0)&&d.push(a.type(b)==="string"?""+b:b)}):a.type(h.transport)==="object"||a.inArray(h.transport,f)>=0?d.push(h.transport):d=f,i(d)}})},0),j.promise())},starting:function(b){var c=this,d=a(c);return d.bind(e.onStarting,function(a,f){b.call(c),d.unbind(e.onStarting)}),c},send:function(a){var b=this;if(!b.transport)throw"SignalR: Connection must be started before data can be sent. Call .start() before .send()";return b.transport.send(b,a),b},sending:function(b){var c=this;return a(c).bind(e.onSending,function(a,d){b.call(c)}),c},received:function(b){var c=this;return a(c).bind(e.onReceived,function(a,d){b.call
(c,d)}),c},error:function(b){var c=this;return a(c).bind(e.onError,function(a,d){b.call(c,d)}),c},disconnected:function(b){var c=this;return a(c).bind(e.onDisconnect,function(a,d){b.call(c)}),c},reconnected:function(b){var c=this;return a(c).bind(e.onReconnect,function(a,d){b.call(c)}),c},stop:function(){var b=this;return b.transport&&(b.transport.stop(b),b.transport=null),delete b.messageId,delete b.groups,a(b).trigger(e.onDisconnect),b},log:f},c.fn.init.prototype=c.fn;var g={addQs:function(c,d){return d.qs?typeof d.qs=="object"?c+"&"+a.param(d.qs):typeof d.qs=="string"?c+"&"+d.qs:c+"&"+b.escape(d.qs.toString()):c},getUrl:function(a,c,d,e){var f=a.url,g="transport="+c+"&connectionId="+b.escape(a.id);return a.data&&(g+="&connectionData="+b.escape(a.data)),d?(e&&(f+="/reconnect"),a.messageId&&(g+="&messageId="+a.messageId),a.groups&&(g+="&groups="+b.escape(JSON.stringify(a.groups)))):f+="/connect",f+="?"+g,f=this.addQs(f,a),f},ajaxSend:function(c,d){var f=c.url+"/send"+"?transport="+c.transport
.name+"&connectionId="+b.escape(c.id);f=this.addQs(f,c),a.ajax({url:f,global:!1,type:"POST",dataType:c.ajaxDataType,data:{data:d},success:function(b){b&&a(c).trigger(e.onReceived,[b])},error:function(b,d){if(d==="abort"||d==="parsererror"&&c.ajaxDataType==="jsonp")return;a(c).trigger(e.onError,[b])}})},processMessages:function(b,c){var d=a(b);if(c){if(c.Disconnect){f("Disconnect command received from server",b.logging),b.stop(),d.trigger(e.onDisconnect);return}c.Messages&&a.each(c.Messages,function(){try{d.trigger(e.onReceived,[this])}catch(c){f("Error raising received "+c,b.logging),a(b).trigger(e.onError,[c])}}),c.MessageId&&(b.messageId=c.MessageId),c.TransportData&&(b.groups=c.TransportData.Groups)}},foreverFrame:{count:0,connections:{}}};c.transports={webSockets:{name:"webSockets",send:function(a,b){a.socket.send(b)},start:function(c,d,g){var h,i=!1,j;b.MozWebSocket&&(b.WebSocket=b.MozWebSocket);if(!b.WebSocket){g();return}c.socket||(c.webSocketServerUrl?h=c.webSocketServerUrl:(j=document
.location.protocol==="https:"?"wss://":"ws://",h=j+document.location.host+c.appRelativeUrl),a(c).trigger(e.onSending),c.data?h+="?connectionData="+c.data+"&transport=webSockets&connectionId="+c.id:h+="?transport=webSockets&connectionId="+c.id,c.socket=new b.WebSocket(h),c.socket.onopen=function(){i=!0,d&&d()},c.socket.onclose=function(b){i?typeof b.wasClean!="undefined"&&b.wasClean===!1&&a(c).trigger(e.onError):g&&g(),c.socket=null},c.socket.onmessage=function(d){var g=b.JSON.parse(d.data),h;g&&(h=a(c),g.Messages?a.each(g.Messages,function(){try{h.trigger(e.onReceived,[this])}catch(a){f("Error raising received "+a,c.logging)}}):h.trigger(e.onReceived,[g]))})},stop:function(a){a.socket!==null&&(a.socket.close(),a.socket=null)}},serverSentEvents:{name:"serverSentEvents",timeOut:3e3,start:function(c,d,h){var i=this,j=!1,k=a(c),l=!d,m,n;c.eventSource&&c.stop();if(!b.EventSource){h&&h();return}k.trigger(e.onSending),m=g.getUrl(c,this.name,l);try{c.eventSource=new b.EventSource(m)}catch(o){f("EventSource failed trying to connect with error "+
o.Message,c.logging),h?h():(k.trigger(e.onError,[o]),l&&(f("EventSource reconnecting",c.logging),i.reconnect(c)));return}n=b.setTimeout(function(){j===!1&&(f("EventSource timed out trying to connect",c.logging),h&&h(),l?(f("EventSource reconnecting",c.logging),i.reconnect(c)):i.stop(c))},i.timeOut),c.eventSource.addEventListener("open",function(a){f("EventSource connected",c.logging),n&&b.clearTimeout(n),j===!1&&(j=!0,d&&d(),l&&k.trigger(e.onReconnect))},!1),c.eventSource.addEventListener("message",function(a){if(a.data==="initialized")return;g.processMessages(c,b.JSON.parse(a.data))},!1),c.eventSource.addEventListener("error",function(a){if(!j){h&&h();return}f("EventSource readyState: "+c.eventSource.readyState,c.logging),a.eventPhase===b.EventSource.CLOSED?c.eventSource.readyState===b.EventSource.CONNECTING?(f("EventSource reconnecting due to the server connection ending",c.logging),i.reconnect(c)):(f("EventSource closed",c.logging),i.stop(c)):(f("EventSource error",c.logging),k.trigger
(e.onError))},!1)},reconnect:function(a){var c=this;b.setTimeout(function(){c.stop(a),c.start(a)},a.reconnectDelay)},send:function(a,b){g.ajaxSend(a,b)},stop:function(a){a&&a.eventSource&&(a.eventSource.close(),a.eventSource=null,delete a.eventSource)}},foreverFrame:{name:"foreverFrame",timeOut:3e3,start:function(c,d,h){var i=this,j=g.foreverFrame.count+=1,k,l,m=a("<iframe data-signalr-connection-id='"+c.id+"' style='position:absolute;top:0;left:0;width:0;height:0;visibility:hidden;'></iframe>");if(b.EventSource){h&&h();return}a(c).trigger(e.onSending),k=g.getUrl(c,this.name),k+="&frameId="+j,m.prop("src",k),g.foreverFrame.connections[j]=c,m.bind("readystatechange",function(){a.inArray(this.readyState,["loaded","complete"])>=0&&(f("Forever frame iframe readyState changed to "+this.readyState+", reconnecting",c.logging),i.reconnect(c))}),c.frame=m[0],c.frameId=j,d&&(c.onSuccess=d),a("body").append(m),l=b.setTimeout(function(){c.onSuccess&&(i.stop(c),h&&h())},i.timeOut)},reconnect:function(
a){var c=this;b.setTimeout(function(){var b=a.frame,d=g.getUrl(a,c.name,!0)+"&frameId="+a.frameId;b.src=d},a.reconnectDelay)},send:function(a,b){g.ajaxSend(a,b)},receive:g.processMessages,stop:function(b){b.frame&&(b.frame.stop?b.frame.stop():b.frame.document&&b.frame.document.execCommand&&b.frame.document.execCommand("Stop"),a(b.frame).remove(),delete g.foreverFrame.connections[b.frameId],b.frame=null,b.frameId=null,delete b.frame,delete b.frameId)},getConnection:function(a){return g.foreverFrame.connections[a]},started:function(b){b.onSuccess?(b.onSuccess(),b.onSuccess=null,delete b.onSuccess):a(b).trigger(e.onReconnect)}},longPolling:{name:"longPolling",reconnectDelay:3e3,start:function(c,d,f){var h=this;c.pollXhr&&c.stop(),c.messageId=null,b.setTimeout(function(){(function f(d,i){a(d).trigger(e.onSending);var j=d.messageId,k=j===null,l=g.getUrl(d,h.name,!k,i),m=null,n=!1;d.pollXhr=a.ajax({url:l,global:!1,type:"GET",dataType:c.ajaxDataType,success:function(c){var h=0,j=!1;i===!0&&n===!1&&
(a(d).trigger(e.onReconnect),n=!0),g.processMessages(d,c),c&&c.TransportData&&a.type(c.TransportData.LongPollDelay)==="number"&&(h=c.TransportData.LongPollDelay),c&&c.TimedOut&&(j=c.TimedOut),h>0?b.setTimeout(function(){f(d,j)},h):f(d,j)},error:function(g,h){if(h==="abort")return;m&&clearTimeout(m),a(d).trigger(e.onError,[g]),b.setTimeout(function(){f(d,!0)},c.reconnectDelay)}}),i===!0&&(m=b.setTimeout(function(){n===!1&&(a(d).trigger(e.onReconnect),n=!0)},h.reconnectDelay))})(c),b.setTimeout(d,150)},250)},send:function(a,b){g.ajaxSend(a,b)},stop:function(a){a.pollXhr&&(a.pollXhr.abort(),a.pollXhr=null,delete a.pollXhr)}}},c.noConflict=function(){return a.connection===c&&(a.connection=d),c},a.connection&&(d=a.connection),a.connection=a.signalR=c})(window.jQuery,window)})