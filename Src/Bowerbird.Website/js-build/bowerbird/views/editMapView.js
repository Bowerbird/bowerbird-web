define(["jquery","underscore","backbone","app","views/dummyoverlayview","jqueryui/autocomplete","jqueryui/draggable","async!http://maps.google.com/maps/api/js?sensor=false&region=AU"],function(a,b,c,d,e){var f=c.View.extend({id:"location-fieldset",initialize:function(a){this.observation=a.observation,this.mapMarker=null,this.zIndex=0},render:function(){return this._initMap(),this._initAddressField(),this._initLocationPin(),this},_initMap:function(){var a=google.maps,b={center:new a.LatLng(-29.191427,134.472126),zoom:4,panControl:!1,streetViewControl:!1,mapTypeControl:!0,scrollwheel:!1,mapTypeId:a.MapTypeId.TERRAIN};this.map=new a.Map(document.getElementById("location-map"),b),this.iw=new a.InfoWindow,this.geocoder=new a.Geocoder,this.dummy=new e(this.map)},_initAddressField:function(){var b=this;this.$el.find("#Address").autocomplete({source:function(c,d){b.geocoder.geocode({address:c.term,region:"AU"},function(b,c){d(a.map(b,function(a){return{label:a.formatted_address,value:a.formatted_address
,latitude:a.geometry.location.lat(),longitude:a.geometry.location.lng()}}))})},select:function(a,c){var d=new google.maps.LatLng(c.item.latitude,c.item.longitude);b._positionMarker(d),b._removeMarkerFromPlaceholder(),b._reverseGeocode();var e=b.mapMarker.getPosition(),f=new google.maps.LatLng(e.lat()+.02,e.lng());b.map.panTo(f)}})},_initLocationPin:function(){var b=this;a("#location-pin").draggable({stop:function(c,d){var e=a(b.map.getDiv()),f=e.offset().left,g=e.offset().top,h=e.width(),i=e.height(),j=d.helper.offset().left,k=d.helper.offset().top,l=d.helper.width(),m=d.helper.height(),n=j+l/2,o=k+m/2-6;if(n>f&&n<f+h&&o>g&&o<g+i){var p=google.maps,q=new p.Point(n-f,o-g+m/2),r=b.dummy.getProjection(),s=r.fromContainerPixelToLatLng(q);b._positionMarker(s),b._removeMarkerFromPlaceholder(),b._reverseGeocode()}}})},_positionMarker:function(a){this.mapMarker&&(this.mapMarker.setMap(null),this.mapMarker=null);var b=google.maps,c=new b.MarkerImage("http://maps.gstatic.com/mapfiles/ms/icons/blue-dot.png"
,new b.Size(32,32),new b.Point(0,0),new b.Point(15,32)),d=new b.MarkerImage("http://maps.gstatic.com/mapfiles/kml/paddle/A_maps.shadow.png",new b.Size(59,32),new b.Point(0,0),new b.Point(15,32));this.mapMarker=new b.Marker({position:a,map:this.map,clickable:!0,draggable:!0,raiseOnDrag:!1,icon:c,shadow:d,zIndex:this._highestOrder()});var e=this;b.event.addListener(this.mapMarker,"drag",function(){e._displayLatLong(!1)}),b.event.addListener(this.mapMarker,"dragstart",function(){e.zIndex++,e.mapMarker.setZIndex(e._highestOrder())}),b.event.addListener(this.mapMarker,"dragend",function(){e._displayLatLong(!0),e._reverseGeocode()}),this._displayLatLong()},_highestOrder:function(){return this.zIndex},changeMarkerPosition:function(a,b){var c=new google.maps.LatLng(a,b);this.mapMarker===null?(this._positionMarker(c),this._removeMarkerFromPlaceholder(),this._reverseGeocode()):(this._positionMarker(c),this._reverseGeocode());if(!this.map.getBounds().contains(this.mapMarker.getPosition())){var d=this
.mapMarker.getPosition(),e=new google.maps.LatLng(d.lat()+.02,d.lng());this.map.panTo(e)}},_displayLatLong:function(b){if(!this.mapMarker)return;var c=this.mapMarker.getPosition().lat(),d=this.mapMarker.getPosition().lng();a("#Latitude").val(c),a("#Longitude").val(d),b&&a("#Longitude").change()},_removeMarkerFromPlaceholder:function(){a("#location-pin").remove()},_reverseGeocode:function(){this.mapMarker&&this.geocoder.geocode({latLng:this.mapMarker.getPosition()},this._reverseGeocodeResult)},_reverseGeocodeResult:function(b,c){if(c=="OK")if(b.length==0)a("#Address").val("");else{var d=b[0].formatted_address;a("#Address").val(d)}else a("#Address").val("");a("#Address").change()}});return f})